<div class="product-card" [ngClass]="view" (click)="onProductClick($event)">
  <div class="top-bar">
    <div class="actions">
      <span (click)="toggleFavorite($event)" [class.active]="product.isFavorite">‚ù§</span>
      <span *ngIf="showCompare" (click)="toggleCompare($event)" [class.active]="product.compare">‚áÑ</span>
    </div>
  </div>

  <div class="image-wrapper">
    <img *ngIf="product.imageLinks" [src]="
        product.imageLinks[0] || 'assets/images/no-image.png'
          | cleanStringLink
      " alt="{{ product.fullName }}" />
    <img *ngIf="product.productImageLinks" [src]="
        product.productImageLinks[0] || 'assets/images/no-image.png'
          | cleanStringLink
      " alt="{{ product.fullName }}" />

    <button class="quick-view" *ngIf="hovered" (click)="openQuickView()">üëÅ –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
  </div>

  <div class="content">
    <span id="article">–∞—Ä—Ç–∏–∫—É–ª: {{ product.article }}</span>
    <h4>{{ product.fullName }}</h4>
    <!-- –í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ price-units-block -->
    <div class="price-display-block" *ngIf="getPrice(city$ | async)">
      <!-- –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –∏ —Å–∫–∏–¥–∫–∞ -->
      <span class="old-price" *ngIf="product.oldPrice">
        {{ product.oldPrice }} ‚ÇΩ
      </span>
      <div class="discount-badge" *ngIf="product.oldPrice">
        -{{ (1 - getPrice(city$ | async) / product.oldPrice) * 100 | number:'1.0-0' }}%
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ -->
      <div class="main-unit-price">
        <div class="unit-label">
          <span class="unit-title">–£–ø–∞–∫–æ–≤–∫–∞</span>
          <span class="unit-details" *ngIf="product.packCount">
            {{ product.packCount }} —à—Ç
          </span>
        </div>
        <span class="unit-value">
          {{ getPrice(city$ | async) | number:'1.0-0' }}
        </span>
      </div>

      <!-- –í—Ç–æ—Ä–∏—á–Ω—ã–µ —Ü–µ–Ω—ã -->
      <div class="secondary-units">
        <div class="unit-chip highlight" *ngIf="product.packCount">
          <span class="chip-label">–ó–∞ 1 —à—Ç—É–∫—É</span>
          <span class="chip-value">
            {{ (getPrice(city$ | async) / product.packCount) | number:'1.0-1' }}
          </span>
        </div>

        <div class="unit-chip" *ngIf="product.boxCount && product.packCount">
          <span class="chip-label">–ö–æ—Ä–æ–±–∫–∞</span>
          <span class="chip-value">
            {{ (getPrice(city$ | async) * product.boxCount) | number:'1.0-0' }}
          </span>
          <span class="chip-details">
            {{ product.boxCount }} —É–ø √ó {{ product.packCount }} —à—Ç
          </span>
        </div>
      </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã -->
    <div class="cart-control-section">
      <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã -->
      <div *ngIf="isInActiveBasket()" class="active-basket-controls">
        <div class="add-cart-wrapper">
          <div class="quantity-selector">
            <button class="add-cart" (click)="addToActiveBasket()">–í –∫–æ—Ä–∑–∏–Ω–µ</button>
            <div class="quantity-controls">
              <button class="quantity-btn" (click)="updateActiveBasketQty(-1)">‚àí</button>
              <input class="input-quantity" type="number" [value]="getActiveBasketCount()" min="1"
                (change)="updateActiveBasketQtyFromInput($event)" />
              <button class="quantity-btn" (click)="updateActiveBasketQty(1)">+</button>
            </div>
          </div>

          <button class="cart-arrow" *ngIf="baskets?.length" (click)="toggleBasketPopup($event)">
            <span class="arrow-icon"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                <linearGradient id="GradientSwatch" gradientUnits="userSpaceOnUse" x1="2" x2="14" y1="3" y2="13">
                  <stop offset="0" stop-color="#87f1fc"></stop>
                  <stop offset="0.2557" stop-color="#7fd4fb"></stop>
                  <stop offset="0.5295" stop-color="#78bcfb"></stop>
                  <stop offset="0.7844" stop-color="#74aefa"></stop>
                  <stop offset="1" stop-color="#73a9fa"></stop>
                </linearGradient>
                <path
                  d="M12.5 2.5H10c0 0.1-0.1 0.3-0.2 0.4-0.2 0.3-0.5 0.6-0.9 0.7-0.2 0.1-0.4 0.1-0.6 0.1H7.7c-0.2 0-0.4 0-0.6-0.1-0.4-0.1-0.7-0.4-0.9-0.7-0.1-0.1-0.2-0.3-0.2-0.4H3.5C2.7 2.5 2 3.2 2 4v9c0 0.8 0.7 1.5 1.5 1.5h9c0.8 0 1.5-0.7 1.5-1.5V4c0-0.8-0.7-1.5-1.5-1.5zM11 12H5c-0.3 0-0.5-0.2-0.5-0.5s0.2-0.5 0.5-0.5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 12 11 12zM11 9H5c-0.3 0-0.5-0.2-0.5-0.5S4.7 8 5 8h6c0.3 0 0.5 0.2 0.5 0.5S11.3 9 11 9zM11 6H5C4.7 6 4.5 5.8 4.5 5.5S4.7 5 5 5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 6 11 6zM9 3.5c0 0.3-0.2 0.5-0.5 0.5h-3C5.2 4 5 3.8 5 3.5S5.2 3 5.5 3h3c0.3 0 0.5 0.2 0.5 0.5z"
                  fill="url(#GradientSwatch)" style="fill: rgb(50, 113, 32);"></path>
                <circle cx="12.5" cy="4.5" r="1" fill="url(#GradientSwatch)" opacity="0.8"></circle>
              </svg></span>
            <span class="basket-badge" *ngIf="getProductBaskets().length > 0">
              {{ getProductBaskets().length }}
            </span>
          </button>

          <!-- –ü–æ–ø–∞–ø —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ—Ä–∑–∏–Ω -->
          <div class="basket-popup" *ngIf="showBasketPopup" (click)="$event.stopPropagation()">
            <div *ngIf="baskets?.length; else noBaskets">
              <!-- <div class="basket-item" *ngFor="let basket of baskets" (click)="selectBasket(basket)">
                {{ basket.name }}
              </div> -->
              <div class="basket-summary">
                <span class="basket-icon">üõí</span>
                <span class="total-count">–í—Å–µ–≥–æ: {{ getTotalProductCount() }} —à—Ç.</span>
                <span class="baskets-count" (click)="showBasketDetails($event)">
                  –≤ {{ getProductBaskets().length }} –∫–æ—Ä–∑–∏–Ω–µ
                </span>
              </div>

              <div class="basket-details-header">
                <strong>–¢–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–∞—Ö:</strong>
                <button class="close-details" (click)="hideBasketDetails()">‚úï</button>
              </div>
              <div *ngFor="let basketItem of getProductBaskets()" class="basket-detail-item">
                <span class="basket-name">{{ basketItem.userBasketName }}</span>
                <div class="basket-detail">
                  <span class="basket-count">{{ basketItem.count }} —à—Ç.</span>
                  <span class="basket-total">{{ basketItem.totalCost }} ‚ÇΩ</span>
                  <div class="basket-actions">
                    <button class="mini-btn minus" (click)="updateBasketItem(basketItem, -1)">-</button>
                    <button class="mini-btn plus" (click)="updateBasketItem(basketItem, 1)">+</button>
                    <button class="mini-btn remove" (click)="removeFromSpecificBasket(basketItem)">‚úï</button>
                  </div>
                </div>
              </div>

            </div>
            <ng-template #noBaskets>
              <div class="no-baskets">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω</div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ, –Ω–æ –µ—Å—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫–æ—Ä–∑–∏–Ω–∞—Ö -->
      <div *ngIf="!isInActiveBasket() && hasProductInBaskets()" class="add-to-active-basket">
        <div class="add-cart-wrapper">
          <button class="add-cart" (click)="addToActiveBasket()">
            –î–æ–±–∞–≤–∏—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É
          </button>

          <button class="cart-arrow" *ngIf="baskets?.length" (click)="toggleBasketPopup($event)">
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
              <linearGradient id="GradientSwatch" gradientUnits="userSpaceOnUse" x1="2" x2="14" y1="3" y2="13">
                <stop offset="0" stop-color="#87f1fc"></stop>
                <stop offset="0.2557" stop-color="#7fd4fb"></stop>
                <stop offset="0.5295" stop-color="#78bcfb"></stop>
                <stop offset="0.7844" stop-color="#74aefa"></stop>
                <stop offset="1" stop-color="#73a9fa"></stop>
              </linearGradient>
              <path
                d="M12.5 2.5H10c0 0.1-0.1 0.3-0.2 0.4-0.2 0.3-0.5 0.6-0.9 0.7-0.2 0.1-0.4 0.1-0.6 0.1H7.7c-0.2 0-0.4 0-0.6-0.1-0.4-0.1-0.7-0.4-0.9-0.7-0.1-0.1-0.2-0.3-0.2-0.4H3.5C2.7 2.5 2 3.2 2 4v9c0 0.8 0.7 1.5 1.5 1.5h9c0.8 0 1.5-0.7 1.5-1.5V4c0-0.8-0.7-1.5-1.5-1.5zM11 12H5c-0.3 0-0.5-0.2-0.5-0.5s0.2-0.5 0.5-0.5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 12 11 12zM11 9H5c-0.3 0-0.5-0.2-0.5-0.5S4.7 8 5 8h6c0.3 0 0.5 0.2 0.5 0.5S11.3 9 11 9zM11 6H5C4.7 6 4.5 5.8 4.5 5.5S4.7 5 5 5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 6 11 6zM9 3.5c0 0.3-0.2 0.5-0.5 0.5h-3C5.2 4 5 3.8 5 3.5S5.2 3 5.5 3h3c0.3 0 0.5 0.2 0.5 0.5z"
                fill="url(#GradientSwatch)" style="fill: rgb(50, 113, 32);"></path>
              <circle cx="12.5" cy="4.5" r="1" fill="url(#GradientSwatch)" opacity="0.8"></circle>
            </svg>
          </button>

          <!-- –ü–æ–ø–∞–ø —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ—Ä–∑–∏–Ω -->
          <div class="basket-popup" *ngIf="showBasketPopup" (click)="$event.stopPropagation()">
            <div *ngIf="baskets?.length; else noBaskets">
              <div class="basket-item" *ngFor="let basket of baskets" (click)="selectBasket(basket)">
                {{ basket.name }}
              </div>
            </div>
            <ng-template #noBaskets>
              <div class="no-baskets">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω</div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –Ω–∏ –≤ –æ–¥–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ -->
      <div *ngIf="!hasProductInBaskets()" class="add-to-cart-section">
        <div class="add-cart-wrapper">
          <div class="quantity-selector" *ngIf="quantitySelectorVisible">
            <div class="quantity-controls">
              <button class="quantity-btn" (click)="decreaseQty()">‚àí</button>
              <input class="input-quantity" type="number" [(ngModel)]="selectedQuantity" min="1" />
              <button class="quantity-btn" (click)="increaseQty()">+</button>
            </div>
          </div>

          <button *ngIf="!quantitySelectorVisible" class="add-cart" (click)="addOneToCart()">
            –í –∫–æ—Ä–∑–∏–Ω—É
          </button>
          <button class="cart-arrow" *ngIf="baskets?.length" (click)="toggleBasketPopup($event)">
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
              <linearGradient id="GradientSwatch" gradientUnits="userSpaceOnUse" x1="2" x2="14" y1="3" y2="13">
                <stop offset="0" stop-color="#87f1fc"></stop>
                <stop offset="0.2557" stop-color="#7fd4fb"></stop>
                <stop offset="0.5295" stop-color="#78bcfb"></stop>
                <stop offset="0.7844" stop-color="#74aefa"></stop>
                <stop offset="1" stop-color="#73a9fa"></stop>
              </linearGradient>
              <path
                d="M12.5 2.5H10c0 0.1-0.1 0.3-0.2 0.4-0.2 0.3-0.5 0.6-0.9 0.7-0.2 0.1-0.4 0.1-0.6 0.1H7.7c-0.2 0-0.4 0-0.6-0.1-0.4-0.1-0.7-0.4-0.9-0.7-0.1-0.1-0.2-0.3-0.2-0.4H3.5C2.7 2.5 2 3.2 2 4v9c0 0.8 0.7 1.5 1.5 1.5h9c0.8 0 1.5-0.7 1.5-1.5V4c0-0.8-0.7-1.5-1.5-1.5zM11 12H5c-0.3 0-0.5-0.2-0.5-0.5s0.2-0.5 0.5-0.5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 12 11 12zM11 9H5c-0.3 0-0.5-0.2-0.5-0.5S4.7 8 5 8h6c0.3 0 0.5 0.2 0.5 0.5S11.3 9 11 9zM11 6H5C4.7 6 4.5 5.8 4.5 5.5S4.7 5 5 5h6c0.3 0 0.5 0.2 0.5 0.5S11.3 6 11 6zM9 3.5c0 0.3-0.2 0.5-0.5 0.5h-3C5.2 4 5 3.8 5 3.5S5.2 3 5.5 3h3c0.3 0 0.5 0.2 0.5 0.5z"
                fill="url(#GradientSwatch)" style="fill: rgb(50, 113, 32);"></path>
              <circle cx="12.5" cy="4.5" r="1" fill="url(#GradientSwatch)" opacity="0.8"></circle>
            </svg>

            <span class="basket-badge" *ngIf="getProductBaskets().length > 0">
              {{ getProductBaskets().length }}
            </span>
          </button>
          <!-- –ü–æ–ø–∞–ø —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ—Ä–∑–∏–Ω -->
          <div class="basket-popup" *ngIf="showBasketPopup" (click)="$event.stopPropagation()">
            <div *ngIf="baskets?.length; else noBaskets">
              <div class="basket-item" *ngFor="let basket of baskets" (click)="selectBasket(basket)">
                {{ basket.name }}
              </div>
            </div>
            <ng-template #noBaskets>
              <div class="no-baskets">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω</div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞ -->
<div class="quick-view-modal" *ngIf="showQuickView">
  <div class="overlay" (click)="closeQuickView()"></div>

  <div class="modal-content">
    <button class="close" (click)="closeQuickView()">‚úñ</button>

    <div class="modal-body">
      <div class="product-left">
        <img [src]="product.productImageLinks[0] || 'assets/images/no-image.png'" alt="{{ product.fullName }}" />
      </div>

      <div class="product-right">
        <h3>{{ product.fullName }}</h3>
        <span class="product-id">–ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}</span>

        <p class="description">{{ product.description }}</p>

        <!-- –ë–ª–æ–∫ —Ü–µ–Ω –≤ –º–æ–¥–∞–ª–∫–µ -->
        <div class="price-units-block-modal">
          <div class="price-unit-main">
            <div class="unit-price-large">
              <span class="unit-type">–£–ø–∞–∫–æ–≤–∫–∞:</span>
              <span class="unit-value-large">{{ getPrice(city$ | async) | number:'1.0-0' }} ‚ÇΩ</span>
              <span *ngIf="product.packCount" class="unit-count">({{ product.packCount }} —à—Ç.)</span>
            </div>
            <div class="unit-prices-list">
              <div class="unit-price-item" *ngIf="product.packCount">
                <span class="item-label">–ó–∞ —à—Ç—É–∫—É:</span>
                <span class="item-value">{{ (getPrice(city$ | async) / product.packCount) | number:'1.0-1' }} ‚ÇΩ</span>
              </div>
              <div class="unit-price-item" *ngIf="product.boxCount && product.packCount">
                <span class="item-label">–ö–æ—Ä–æ–±–∫–∞ ({{ product.boxCount }} —É–ø.):</span>
                <span class="item-value">{{ (getPrice(city$ | async) * product.boxCount) | number:'1.0-0' }} ‚ÇΩ</span>
              </div>
            </div>
          </div>

          <div class="old-price-discount-modal" *ngIf="product.oldPrice">
            <span class="old-price-modal">{{ product.oldPrice }} ‚ÇΩ</span>
            <span class="discount-modal">
              -{{ (1 - getPrice(city$ | async) / product.oldPrice) * 100 | number:'1.0-0' }}%
            </span>
          </div>
        </div>

        <div class="extra-info-modal">
          <div class="info-row" *ngIf="product.remains.length > 0">
            <span class="info-label">–í –Ω–∞–ª–∏—á–∏–∏:</span>
            <span class="info-value">{{ product.remains[0].quantity }} —É–ø.</span>
          </div>
          <div class="info-row" *ngIf="product.packCount">
            <span class="info-label">–í —É–ø–∞–∫–æ–≤–∫–µ:</span>
            <span class="info-value">{{ product.packCount }} —à—Ç.</span>
          </div>
          <div class="info-row" *ngIf="product.boxCount">
            <span class="info-label">–í –∫–æ—Ä–æ–±–∫–µ:</span>
            <span class="info-value">{{ product.boxCount }} —É–ø.</span>
          </div>
          <div class="info-row" *ngIf="product.grossWeight">
            <span class="info-label">–í–µ—Å:</span>
            <span class="info-value">{{ product.grossWeight }} –≥</span>
          </div>
          <div class="info-row" *ngIf="product.height && product.width && product.depth">
            <span class="info-label">–†–∞–∑–º–µ—Ä:</span>
            <span class="info-value">{{ product.width }}√ó{{ product.height }}√ó{{ product.depth }} –º–º</span>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
        <div class="cart-control-modal">
          <div *ngIf="isInActiveBasket()" class="active-basket-controls">
            <div class="quantity-selector">
              <div class="quantity-controls">
                <button class="quantity-btn" (click)="updateActiveBasketQty(-1)">‚àí</button>
                <input class="input-quantity" type="number" [value]="getActiveBasketCount()" min="1"
                  (change)="updateActiveBasketQtyFromInput($event)" />
                <button class="quantity-btn" (click)="updateActiveBasketQty(1)">+</button>
              </div>
            </div>
          </div>

          <div *ngIf="!isInActiveBasket()">
            <div class="quantity-selector">
              <button class="quantity-btn" (click)="decreaseQty()">‚àí</button>
              <input type="number" [(ngModel)]="selectedQuantity" min="1" />
              <button class="quantity-btn" (click)="increaseQty()">+</button>
            </div>

            <button class="add-cart" (click)="addToActiveBasket()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>

        <div class="total-price" *ngIf="isInActiveBasket()">
          –û–±—â–∞—è —Å—É–º–º–∞: {{ getActiveBasketTotal() }} ‚ÇΩ
        </div>
        <div class="total-price" *ngIf="!isInActiveBasket()">
          –û–±—â–∞—è —Å—É–º–º–∞: {{ getTotalPrice(city$ | async) }} ‚ÇΩ
        </div>
      </div>
    </div>
  </div>
</div>