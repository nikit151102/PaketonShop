<div class="pickup-delivery-modern">
  <!-- Заголовок -->
  <div class="pickup-header">
    <h3 class="pickup-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41V15z"/>
      </svg>
      Самовывоз из пункта выдачи
    </h3>
    <p class="pickup-subtitle">Выберите город и удобный для вас пункт выдачи заказов</p>
  </div>

  <!-- Выбранный магазин -->
  <div class="selected-store-card" *ngIf="selectedStore && viewMode === 'city'">
    <div class="selected-store-header">
      <div class="store-badge">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <span>Выбрано</span>
      </div>
      <button class="change-store-btn" (click)="switchToListView()">
        Изменить
      </button>
    </div>
    
    <div class="selected-store-content">
      <div class="store-logo">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41V15z"/>
        </svg>
      </div>
      
      <div class="store-info">
        <h4 class="store-name">{{ selectedStore.shortName || selectedStore.fullName }}</h4>
        <p class="store-address">{{ getFullAddress(selectedStore) }}</p>
        
        <div class="store-status" [class.open]="isStoreOpen(selectedStore)">
          <div class="status-indicator"></div>
          <span *ngIf="isStoreOpen(selectedStore)">
            Открыто до {{ getTodaySchedule(selectedStore).closeTime }}
          </span>
          <span *ngIf="!isStoreOpen(selectedStore)">
            Закрыто • Откроется {{ getTodaySchedule(selectedStore).openTime }}
          </span>
        </div>
        
        <div class="store-details">
          <div class="detail-item">
            <span class="detail-label">Город:</span>
            <span class="detail-value">{{ selectedStore.address.city }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="store-schedule">
      <h5>График работы:</h5>
      <div class="schedule-days">
        <div class="schedule-day" *ngFor="let day of getStoreHoursInfo(selectedStore)">
          <span class="day-name">{{ day.dayName }}</span>
          <span class="day-hours" *ngIf="day.isWorkingDay">
            {{ day.openTime }} - {{ day.closeTime }}
            <span class="today-badge" *ngIf="day.isToday">Сегодня</span>
          </span>
          <span class="day-closed" *ngIf="!day.isWorkingDay">Выходной</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Выбор города -->
  <div class="city-selection" *ngIf="viewMode === 'city' && !selectedStore">
    <div class="section-header">
      <h4>Выберите город для самовывоза</h4>
      <button class="geo-button" (click)="requestGeolocation()" [class.loading]="loading && useGeolocation">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
        </svg>
        {{ useGeolocation ? 'Определение...' : 'Определить автоматически' }}
      </button>
    </div>
    
    <!-- Загрузка городов -->
    <div class="loading-cities" *ngIf="loadingCities">
      <div class="spinner"></div>
      <p>Загрузка списка городов...</p>
    </div>
    
    <!-- Список городов с магазинами -->
    <div class="cities-info" *ngIf="!loadingCities && cities.length > 0">
      <div class="cities-stats">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4-5h2v15h-2z"/>
        </svg>
        <span>Доступно в {{ cities.length }} городах</span>
      </div>
    </div>
    
    <div class="cities-grid">
      <div class="city-card" 
           *ngFor="let city of cities"
           (click)="selectCity(city)">
        <div class="city-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
        </div>
        <div class="city-info">
          <span class="city-name">{{ city }}</span>
          <!-- <span class="city-stores-count">Пункты выдачи доступны</span> -->
        </div>
        <div class="city-arrow">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
          </svg>
        </div>
      </div>
    </div>
    
    <!-- Если нет городов с магазинами -->
    <div class="no-cities" *ngIf="!loadingCities && cities.length === 0">
      <div class="no-cities-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/>
        </svg>
      </div>
      <h4>Нет доступных городов</h4>
      <p>В данный момент самовывоз не доступен в вашем регионе</p>
    </div>
  </div>

  <!-- Список магазинов -->
  <div class="stores-list-view" *ngIf="viewMode === 'list'">
    <div class="stores-header">
      <button class="back-button" (click)="goBackToCitySelection()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
        </svg>
        Назад к выбору города
      </button>
      
      <div class="current-city">
        <span class="city-label">Город:</span>
        <span class="city-name">{{ selectedCity }}</span>
      </div>
      
      <div class="view-toggle">
        <button class="view-btn" [class.active]="viewMode === 'list'" (click)="switchToListView()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
          </svg>
          Список
        </button>
        <button class="view-btn" [class.active]="viewMode === 'map'" (click)="switchToMapView()" [disabled]="stores.length === 0">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
          </svg>
          Карта
        </button>
      </div>
    </div>

    <!-- Загрузка магазинов -->
    <div class="loading-stores" *ngIf="loadingStores">
      <div class="spinner"></div>
      <p>Загрузка пунктов выдачи в {{ selectedCity }}...</p>
    </div>

    <!-- Если магазины загружены -->
    <div *ngIf="!loadingStores">
      <!-- Поиск и фильтры -->
      <div class="search-filters" *ngIf="stores.length > 0">
        <div class="search-box">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5z"/>
          </svg>
          <input type="text" 
                 [(ngModel)]="searchQuery" 
                 (ngModelChange)="onSearchQueryChange()"
                 placeholder="Поиск по названию или адресу..."
                 class="search-input">
          <button class="clear-search" *ngIf="searchQuery" (click)="searchQuery = ''; onSearchQueryChange()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        
        <label class="filter-toggle">
          <input type="checkbox" 
                 [(ngModel)]="showOnlyOpen" 
                 (change)="toggleOpenOnly()"
                 class="toggle-input">
          <span class="toggle-slider"></span>
          <span class="toggle-text">Только открытые сейчас</span>
        </label>
        
        <button class="geo-button-sm" *ngIf="!useGeolocation" (click)="requestGeolocation()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
          Рядом со мной
        </button>
      </div>

      <!-- Результаты -->
      <div class="stores-results" *ngIf="stores.length > 0">
        <div class="results-header">
          <span class="results-count">{{ stores.length }} пунктов выдачи</span>
          <span class="results-note" *ngIf="useGeolocation">
            Сортировка по расстоянию от вас
          </span>
        </div>
        
        <!-- Ближайшие магазины -->
        <!-- <div class="nearby-stores" *ngIf="nearbyStores.length > 0 && useGeolocation">
          <h5 class="nearby-title">Ближайшие к вам:</h5>
          <div class="nearby-list">
            <div class="nearby-store-card"
                 *ngFor="let store of nearbyStores.slice(0, 3)"
                 (click)="selectStore(store)">
              <div class="nearby-store-content">
                <div class="store-name">{{ store.shortName }}</div>
                <div class="store-distance">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                  </svg>
                  {{ formatDistance(getStoreDistance(store) || 0) }}
                </div>
                <div class="store-address">{{ store.address?.street }}, {{ store.address?.house }}</div>
              </div>
              <div class="select-button">
                Выбрать
              </div>
            </div>
          </div>
        </div> -->

        <!-- Все магазины -->
        <div class="all-stores-list">
          <div class="store-card"
               *ngFor="let store of filteredStores"
               (click)="selectStore(store)">
            <div class="card-header">
              <div class="store-logo-sm">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99z"/>
                </svg>
              </div>
              <div class="store-info-sm">
                <h5 class="store-name">{{ store.shortName }}</h5>
                <div class="store-status-sm" [class.open]="isStoreOpen(store)">
                  <div class="status-dot"></div>
                  {{ isStoreOpen(store) ? 'Открыто' : 'Закрыто' }}
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <p class="store-address">{{ getFullAddress(store) }}</p>
              
              <div class="store-details-sm">
                <div class="detail-row">
                  <span class="detail-label">График:</span>
                  <span class="detail-value">
                    {{ getTodaySchedule(store).openTime }} - {{ getTodaySchedule(store).closeTime }}
                  </span>
                </div>
                
                <div class="detail-row" *ngIf="getStoreDistance(store)">
                  <span class="detail-label">Расстояние:</span>
                  <span class="detail-value">
                    {{ formatDistance(getStoreDistance(store)!) }}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="card-actions">
              <button class="select-store-btn" (click)="selectStore(store); $event.stopPropagation()">
                Выбрать
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Если нет магазинов в городе -->
      <div class="no-stores-in-city" *ngIf="stores.length === 0">
        <div class="no-stores-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/>
          </svg>
        </div>
        <h4>Нет пунктов выдачи в {{ selectedCity }}</h4>
        <p>В выбранном городе пока нет доступных пунктов самовывоза</p>
        <button class="back-to-cities-btn" (click)="goBackToCitySelection()">
          Выбрать другой город
        </button>
      </div>
    </div>
  </div>

  <!-- Карта магазинов с Яндекс.Картами -->
  <div class="stores-map-view" *ngIf="viewMode === 'map' && stores.length > 0">
    <div class="map-header">
      <button class="back-button" (click)="switchToListView()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
        </svg>
        Назад к списку
      </button>
      
      <div class="map-title">
        <h4>Карта пунктов выдачи в {{ selectedCity }}</h4>
        <p class="map-subtitle">{{ stores.length }} пунктов на карте</p>
      </div>
      
      <div class="map-actions">
        <button class="geo-button-map" *ngIf="!useGeolocation" (click)="requestGeolocation()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
          Моё местоположение
        </button>
      </div>
    </div>

    <!-- Контейнер для Яндекс.Карт -->
    <div class="map-container">
      <div #mapContainer id="yandex-map" class="yandex-map-container"></div>
      
      <!-- Легенда карты -->
      <div class="map-legend" *ngIf="mapReady">
        <div class="legend-item">
          <div class="legend-icon open"></div>
          <span>Открыто сейчас</span>
        </div>
        <div class="legend-item">
          <div class="legend-icon closed"></div>
          <span>Закрыто</span>
        </div>
        <div class="legend-item" *ngIf="selectedStore">
          <div class="legend-icon selected"></div>
          <span>Выбрано</span>
        </div>
        <div class="legend-item" *ngIf="userLocation">
          <div class="legend-icon user"></div>
          <span>Ваше местоположение</span>
        </div>
      </div>

      <!-- Состояние загрузки карты -->
      <div class="map-loading" *ngIf="!mapReady && !error">
        <div class="spinner"></div>
        <p>Загрузка карты...</p>
      </div>
    </div>

    <!-- Список магазинов на карте -->
    <div class="map-stores-list" *ngIf="stores.length > 0">
      <div class="map-store-card"
           *ngFor="let store of stores.slice(0, 5)"
           [class.selected]="selectedStore?.id === store.id"
           (click)="selectStore(store)">
        <div class="map-store-info">
          <h5>{{ store.shortName }}</h5>
          <p>{{ store.address.street }}, {{ store.address.house }}</p>
          <div class="map-store-details">
            <span class="map-store-status" [class.open]="isStoreOpen(store)">
              {{ isStoreOpen(store) ? 'Открыто' : 'Закрыто' }}
            </span>
            <span class="map-store-distance" *ngIf="getStoreDistance(store)">
              {{ formatDistance(getStoreDistance(store)!) }}
            </span>
          </div>
        </div>
        <button class="map-select-btn" (click)="selectStore(store); $event.stopPropagation()">
          Выбрать
        </button>
      </div>
    </div>
  </div>

  <!-- Общие состояния загрузки и ошибок -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <p>Загрузка...</p>
  </div>
</div>