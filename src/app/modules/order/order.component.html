<div class="order-container">
  <!-- Основной контент -->
  <div class="order-content">
    <div class="order-layout">
      <!-- Левая часть: Форма оформления -->
      <div class="order-form-section">
        <div class="order-form-header">
          <div class="form-header-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M18 17H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V7h12v2zM3 22l1.5-1.5L6 22l1.5-1.5L9 22l1.5-1.5L12 22l1.5-1.5L15 22l1.5-1.5L18 22l1.5-1.5L21 22V2l-1.5 1.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v20z" />
            </svg>
          </div>
          <div class="form-header-content">
            <h2 class="form-title">Оформление заказа</h2>
            <p class="form-subtitle">Заполните данные для завершения покупки</p>
            <div class="order-progress">
              <span class="order-count">{{ getUniqueProductsCount() }} товар{{ getUniqueProductsCount() | plural
                }}</span>
              <span class="order-total">{{ getProductsTotal() | currency:'RUB':'symbol':'1.0-0' }}</span>
            </div>
          </div>
        </div>

        <!-- Форма оформления заказа -->
        <div class="order-form-container">
          <app-order-form [userBasketId]="activeBasketId" (orderCreated)="onOrderCreated($event)"
            (orderUpdated)="onOrderUpdated($event)" (orderDelivery)="onOrderDelivery($event)" (orderCompany)="null" 
            (formChanged)="onFormChanged($event)">
          </app-order-form>
        </div>
      </div>

      <!-- Правая часть: Итоги и чек -->
      <div class="order-summary-section">
        <div class="summary-sticky">
          <!-- Мини-корзина -->
          <div class="mini-cart-card">
            <div class="mini-cart-header">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0 0 20 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
              </svg>
              <h3>Ваша корзина</h3>
              <span class="cart-count">{{ getTotalProductsCount() }}</span>
            </div>

            <!-- Список товаров -->
            <div class="mini-cart-items">
              <div class="mini-cart-item" *ngFor="let product of basketProducts">
                <div class="product-image">
                  <div class="image-placeholder">
                    {{ product.name.charAt(0).toUpperCase() }}
                  </div>
                </div>
                <div class="product-details">
                  <span class="product-name">{{ product.name }}</span>
                  <div class="product-info">
                    <span class="product-qty">{{ product.qty }} шт.</span>
                    <span class="product-unit">× {{ product.price | currency:'RUB':'symbol':'1.0-0' }}</span>
                  </div>
                </div>
                <div class="product-total">
                  {{ (product.price * product.qty) | currency:'RUB':'symbol':'1.0-0' }}
                </div>
              </div>
            </div>
          </div>

          <!-- Итоговый чек -->
          <div class="receipt-card">
            <div class="receipt-header">
              <h4>Итоговый чек</h4>
              <span class="receipt-time">{{ currentDate | date:'dd.MM.yyyy HH:mm' }}</span>
            </div>

            <div class="receipt-items">
              <div class="receipt-row">
                <span class="receipt-label">Товары:</span>
                <span class="receipt-value">{{ getProductsTotal() | currency:'RUB':'symbol':'1.0-0' }}</span>
              </div>

              <div class="receipt-row">
                <span class="receipt-label">Доставка:</span>
                <span class="receipt-value">{{ getDeliveryCost() | currency:'RUB':'symbol':'1.0-0' }}</span>
              </div>

              <div class="receipt-row discount" *ngIf="discount > 0">
                <span class="receipt-label">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z" />
                  </svg>
                  Скидка:
                </span>
                <span class="receipt-value">-{{ discount | currency:'RUB':'symbol':'1.0-0' }}</span>
              </div>

              <div class="receipt-divider"></div>

              <div class="receipt-row total">
                <span class="receipt-label">Итого к оплате:</span>
                <span class="receipt-value total-amount">
                  {{ getOrderTotal() | currency:'RUB':'symbol':'1.0-0' }}
                </span>
              </div>
            </div>

            <!-- Прогресс сохранения -->
            <div class="saving-progress" *ngIf="isSaving">
              <div class="progress-bar">
                <div class="progress-fill" [style.width]="savingProgress + '%'"></div>
              </div>
              <span class="progress-text">Сохранение заказа...</span>
            </div>
          </div>

          <!-- Безопасность и гарантии -->
          <!-- <div class="security-badges">
            <div class="badge">
              <div class="badge-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                </svg>
              </div>
              <div class="badge-content">
                <span class="badge-title">Безопасная оплата</span>
                <span class="badge-subtitle">SSL шифрование</span>
              </div>
            </div>

            <div class="badge">
              <div class="badge-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
              </div>
              <div class="badge-content">
                <span class="badge-title">Гарантия возврата</span>
                <span class="badge-subtitle">30 дней</span>
              </div>
            </div>
          </div> -->

          <!-- Кнопки действий -->
          <div class="action-buttons">
            <button class="action-btn edit-btn" [routerLink]="['/cart']">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
              </svg>
              Изменить корзину
            </button>

            <button class="action-btn checkout-btn" [disabled]="!canProceedToPayment()" (click)="proceedToPayment()"
              [class.loading]="isProcessing">
              <span class="btn-content">
                <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
                  *ngIf="!isProcessing">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
                <svg class="btn-spinner" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
                  *ngIf="isProcessing">
                  <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" opacity="0.3" />
                  <path d="M12 2a10 10 0 0 0 0 20 10 10 0 0 0 0-20zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" />
                </svg>
                <span class="btn-text">
                  {{ isProcessing ? 'Обработка...' : 'Перейти к оплате' }}
                </span>
              </span>
              <span class="btn-total">{{ getOrderTotal() | currency:'RUB':'symbol':'1.0-0' }}</span>
            </button>

            <p class="action-hint">
              Нажимая кнопку, вы соглашаетесь с условиями
              <a href="#" class="action-link">пользовательского соглашения</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Уведомление об успешном создании заказа -->
  <div class="notification-overlay" *ngIf="showSuccessNotification" (click)="showSuccessNotification = false">
    <div class="notification-modal" (click)="$event.stopPropagation()">
      <div class="notification-header">
        <div class="notification-icon success">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
          </svg>
        </div>
        <button class="notification-close" (click)="showSuccessNotification = false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>

      <div class="notification-content">
        <h3>Заказ создан успешно!</h3>
        <p>Ваш заказ <strong>#{{ createdOrderId?.substring(0, 8) }}</strong> готов к оплате.</p>

        <div class="notification-details">
          <div class="detail-item">
            <span class="detail-label">Сумма:</span>
            <span class="detail-value">{{ getOrderTotal() | currency:'RUB':'symbol':'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Товаров:</span>
            <span class="detail-value">{{ getTotalProductsCount() }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Дата:</span>
            <span class="detail-value">{{ currentDate | date:'dd.MM.yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>

      <div class="notification-actions">
        <button class="notification-btn secondary" (click)="showSuccessNotification = false">
          Продолжить оформление
        </button>
        <button class="notification-btn primary" [routerLink]="['/payment', createdOrderId]">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
          Перейти к оплате
        </button>
      </div>
    </div>
  </div>

  <!-- Лоадер -->
  <div class="loader-overlay" *ngIf="isLoading">
    <div class="loader-container">
      <div class="loader-spinner">
        <div class="spinner-circle"></div>
        <div class="spinner-circle"></div>
        <div class="spinner-circle"></div>
      </div>
      <p class="loader-text">Загрузка данных...</p>
    </div>
  </div>
</div>