<div class="product-card" *ngIf="productData as product">
  <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
  <div class="breadcrumbs" *ngIf="breadCrumbs && breadCrumbs.length > 0">
    <a routerLink="/catalog" class="breadcrumb-link">–ö–∞—Ç–∞–ª–æ–≥</a>
    <span class="separator">‚Ä∫</span>
    <ng-container *ngFor="let crumb of breadCrumbs; let last = last">
      <a *ngIf="!last" [routerLink]="['/catalog', crumb.id]" class="breadcrumb-link">
        {{crumb.name}}
      </a>
      <span *ngIf="last" class="breadcrumb-current">{{crumb.name}}</span>
      <span class="separator" *ngIf="!last">‚Ä∫</span>
    </ng-container>
  </div>

  <div class="product-main">
    <!-- –ì–∞–ª–µ—Ä–µ—è -->
    <div class="gallery-section">
      <app-product-gallery [images]="(productData ? productData.productImageLinks : []) | cleanArrayLink">
      </app-product-gallery>
    </div>

    <div class="product-content">
      <div class="product-header">
        <h1 class="product-title">{{ productData.h1Title || productData.fullName }}</h1>
        <div class="product-meta">
          <div class="product-sku">
            <span class="sku-label">–ê—Ä—Ç–∏–∫—É–ª:</span>
            <span class="sku-value">{{ productData.article }}</span>
            <button class="copy-btn" (click)="copyArticle()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ç–∏–∫—É–ª">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
              </svg>
            </button>
          </div>
          <div class="product-badge" *ngIf="productData.isFavorite">
            <span class="badge favorite">‚òÖ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
          </div>
        </div>
      </div>

      <div class="content-wrapper">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="info-section">
          <!-- –¶–µ–Ω–∞ -->
          <div class="price-section">
            <div class="price-main">
              <span class="price-value">{{ productData.viewPrice | number:'1.2-2' }} ‚ÇΩ</span>
              <span class="price-unit">/ {{ productData.measurementUnit?.shortName || '—à—Ç' }}</span>
            </div>
            <div class="price-details">
              <div class="pack-info" *ngIf="productData.packCount">
                <span class="pack-label">–í —É–ø–∞–∫–æ–≤–∫–µ:</span>
                <span class="pack-value">{{ productData.packCount }} —à—Ç</span>
              </div>
            </div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–∞—Ö -->
          <div class="basket-info-section" *ngIf="basketsWithProduct.length > 0">
            <div class="basket-info-header">
              <h3 class="section-title">–í –∫–æ—Ä–∑–∏–Ω–∞—Ö:</h3>
              <button class="basket-info-toggle" (click)="toggleBasketDetailsPopup($event)">
                <span>{{ totalQuantityInBaskets }} —à—Ç. –≤ {{ basketsWithProduct.length }} –∫–æ—Ä–∑–∏–Ω–µ</span>
                <svg [class.expanded]="showBasketDetailsPopup" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                </svg>
              </button>
            </div>

            <div class="basket-info-content" [class.expanded]="showBasketDetailsPopup">
              <div class="basket-list">
                <div class="basket-item" *ngFor="let item of basketsWithProduct">
                  <div class="basket-info">
                    <div class="basket-name">
                      <span class="basket-icon">üõí</span>
                      {{ item.basket.name }}
                      <span *ngIf="item.basket.isActiveBasket" class="active-badge">–ê–∫—Ç–∏–≤–Ω–∞—è</span>
                    </div>
                    <div class="basket-details">
                      <span class="basket-quantity">{{ item.quantity }} —à—Ç.</span>
                      <span class="basket-total">{{ item.totalCost | number:'1.2-2' }} ‚ÇΩ</span>
                    </div>
                  </div>
                  <div class="basket-actions">
                    <button class="mini-btn minus" (click)="updateBasketQuantity(item.basket.id, -1)">-</button>
                    <button class="mini-btn plus" (click)="updateBasketQuantity(item.basket.id, 1)">+</button>
                    <button class="mini-btn remove" (click)="removeFromBasket(item.basket.id)">‚úï</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- –ù–∞–ª–∏—á–∏–µ -->
          <div class="availability-section">
            <div class="availability-header">
              <h3 class="section-title">–ù–∞–ª–∏—á–∏–µ –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö</h3>
              <button class="availability-toggle" (click)="toggleAvailability()">
                <span *ngIf="productData.remains">{{ getAvailableStoresCount() }} –º–∞–≥–∞–∑–∏–Ω–∞(–æ–≤)</span>
                <svg [class.expanded]="showAvailability" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                </svg>
              </button>
            </div>

            <div class="availability-content" [class.expanded]="showAvailability">
              <div class="store-list">
                <div class="store-item" *ngFor="let store of productData.remains">
                  <div class="store-info">
                    <div class="store-name">{{ store.productPlaceName }}</div>
                    <div class="store-stock">
                      <span class="stock-badge" [class.in-stock]="store.count > 0">
                        {{ store.count > 0 ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' }}
                      </span>
                      <span class="stock-count" *ngIf="store.count > 0">{{ store.count }} —à—Ç</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="actions-section">
          <div class="actions-card">
            <!-- –û–±—â–∞—è —Å—É–º–º–∞ -->
            <div class="total-price-section" *ngIf="showQuantityControls && selectedQuantity > 1">
              <span class="total-label">–û–±—â–∞—è —Å—É–º–º–∞:</span>
              <span class="total-value">{{ calculateTotal() | number:'1.2-2' }} ‚ÇΩ</span>
            </div>

            <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã) -->
            <div class="quantity-selector-wrapper" *ngIf="isInActiveBasket">
              <label class="quantity-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
              <div class="quantity-controls">
                <button class="quantity-btn minus" (click)="decreaseQuantity()" [disabled]="selectedQuantity <= 1">-</button>
                <input type="number" [(ngModel)]="selectedQuantity" min="1" (change)="validateQuantity()"
                  class="quantity-input">
                <button class="quantity-btn plus" (click)="increaseQuantity()">+</button>
              </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
              <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ -->
              <div *ngIf="!isInActiveBasket" class="add-to-cart-section">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º –º–µ–Ω—é –∫–æ—Ä–∑–∏–Ω -->
                <div class="add-cart-wrapper">
                  <button class="btn-primary add-cart" (click)="addToActiveBasket()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0 0 20 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                    </svg>
                    {{ isInOtherBaskets ? '–î–æ–±–∞–≤–∏—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É' : '–í –∫–æ—Ä–∑–∏–Ω—É' }}
                  </button>

                  <button class="cart-arrow" *ngIf="baskets?.length" (click)="toggleBasketPopup($event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                    </svg>
                  </button>

                  <!-- –ü–æ–ø–∞–ø —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ—Ä–∑–∏–Ω -->
                  <div class="basket-popup" *ngIf="showBasketPopup" (click)="$event.stopPropagation()">
                    <div *ngIf="baskets?.length; else noBaskets">
                      <div class="basket-item" *ngFor="let basket of baskets" (click)="addToCartWithBasket(basket)">
                        {{ basket.name }}
                        <span *ngIf="basket.isActiveBasket" class="active-indicator">–∞–∫—Ç–∏–≤–Ω–∞—è</span>
                      </div>
                    </div>
                    <ng-template #noBaskets>
                      <div class="no-baskets">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω</div>
                    </ng-template>
                  </div>
                </div>
              </div>

              <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ -->
              <div *ngIf="isInActiveBasket" class="cart-controls">
                <button class="btn-primary" (click)="updateActiveBasketQuantity()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                  –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button class="btn-remove" (click)="removeFromActiveBasket()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>

              <button class="btn-secondary" (click)="toggleFavorite()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path *ngIf="!productData.isFavorite"
                    d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-8.09 10.05z" />
                  <path *ngIf="productData.isFavorite"
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
                {{ productData.isFavorite ? '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' }}
              </button>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ -->
            <div class="delivery-info">
              <div class="info-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M19 7h-.67l-2.41-2.42A.985.985 0 0 0 15.35 4H8.65c-.33 0-.65.17-.82.42L5.68 7H5c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zm-7 11c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                  <circle cx="12" cy="12" r="2.5" />
                </svg>
                <span>–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–Ω—è</span>
              </div>
              <div class="info-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
                <span>–ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>