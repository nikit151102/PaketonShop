<div class="cart-container">
  <!-- Шапка с мульти-корзинами -->
  <div class="cart-header">
    <div class="multi-cart-wrapper">
      <div class="multi-cart-tabs">
        <div class="tabs-scroll">
          <div class="tab" 
               *ngFor="let basket of baskets; let i = index" 
               [class.active]="activeBasket?.id === basket.id"
               (click)="selectBasket(basket)">
            <span class="tab-name">{{ basket.name }}</span>
            <span class="tab-count">{{ basket.productCount || 0 }}</span>
            <button class="tab-close" *ngIf="baskets.length > 1" (click)="deleteBasket(basket, $event)">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <button class="add-tab" (click)="openCreatePopup()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
          <span>Новая корзина</span>
        </button>
      </div>

      <!-- Быстрые действия с корзиной -->
      <div class="basket-actions" *ngIf="activeBasket">
        <button class="icon-btn" (click)="renameBasket()" title="Переименовать">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
        </button>
        <button class="icon-btn" (click)="duplicateBasket()" title="Дублировать">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Прогресс оформления -->
    <div class="checkout-progress">
      <div class="progress-step" [class.completed]="step >= 1" [class.active]="step === 1">
        <div class="step-indicator">
          <span class="step-number" *ngIf="step < 1">1</span>
          <svg class="step-check" *ngIf="step >= 1" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
        <span class="step-label">Корзина</span>
      </div>
      <div class="progress-line" [class.active]="step >= 2"></div>
      <div class="progress-step" [class.completed]="step >= 2" [class.active]="step === 2">
        <div class="step-indicator">
          <span class="step-number" *ngIf="step < 2">2</span>
          <svg class="step-check" *ngIf="step >= 2" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
        <span class="step-label">Оформление</span>
      </div>
      <div class="progress-line" [class.active]="step >= 3"></div>
      <div class="progress-step" [class.completed]="step >= 3" [class.active]="step === 3">
        <div class="step-indicator">
          <span class="step-number" *ngIf="step < 3">3</span>
          <svg class="step-check" *ngIf="step >= 3" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
        <span class="step-label">Оплата</span>
      </div>
    </div>
  </div>

  <!-- Popup для создания/редактирования корзины -->
  <div class="popup-overlay" *ngIf="isPopupOpen" (click)="closePopup()"></div>
  
  <div class="popup" *ngIf="isPopupOpen" [class.rename]="popupMode === 'rename'">
    <div class="popup-header">
      <h3>{{ popupMode === 'create' ? 'Создать корзину' : 'Переименовать корзину' }}</h3>
      <button class="close-btn" (click)="closePopup()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    
    <div class="popup-content">
      <input type="text" 
             [placeholder]="popupMode === 'create' ? 'Введите название корзины' : 'Новое название'"
             [(ngModel)]="popupInputValue"
             (keyup.enter)="confirmPopupAction()"
             class="popup-input"
             autofocus />
      
      <div class="popup-hint" *ngIf="popupMode === 'create'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
        </svg>
        <span>Вы сможете добавить товары позже</span>
      </div>
    </div>
    
    <div class="popup-actions">
      <button class="btn secondary" (click)="closePopup()">Отмена</button>
      <button class="btn primary" 
              (click)="confirmPopupAction()" 
              [disabled]="!popupInputValue.trim()">
        {{ popupMode === 'create' ? 'Создать' : 'Сохранить' }}
      </button>
    </div>
  </div>

  <!-- Основной контент -->
  <div class="cart-content">
    <!-- Статус загрузки -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Загружаем вашу корзину...</p>
    </div>

    <!-- Ошибка загрузки -->
    <div class="error-state" *ngIf="error">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
      </svg>
      <h3>Ошибка загрузки</h3>
      <p>{{ error }}</p>
      <button class="btn primary" (click)="loadBaskets()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
        </svg>
        Повторить
      </button>
    </div>

    <!-- Успешный контент -->
    <ng-container *ngIf="!isLoading && !error">
      <div class="cart-layout">
        <!-- Левая колонка - список товаров -->
        <div class="cart-main">
          <!-- Заголовок с действиями -->
          <div class="cart-header-section">
            <div class="title-group">
              <h1>{{ activeBasket?.name || 'Корзина' }}</h1>
              <span class="item-count">{{ activeBasket?.products?.length || 0 }} товара</span>
            </div>

            <div class="header-actions">
              <!-- Массовые действия -->
              <div class="bulk-actions" *ngIf="selectedProducts.size > 0">
                <span class="selected-count">Выбрано: {{ selectedProducts.size }}</span>
                
                <button class="action-btn" (click)="selectAll()" *ngIf="selectedProducts.size < activeBasket?.products?.length">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM17.99 9l-1.41-1.42-6.59 6.59-2.58-2.57-1.42 1.41 4 4 8-8z"/>
                  </svg>
                  Выбрать все
                </button>
                
                <button class="action-btn danger" (click)="removeSelectedProducts()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  Удалить
                </button>
              </div>

              <!-- Фильтры и сортировка -->
              <div class="filter-actions" *ngIf="!selectedProducts.size">
                <button class="filter-btn" [class.active]="filter === 'all'" (click)="setFilter('all')">
                  Все
                </button>
                <button class="filter-btn" [class.active]="filter === 'available'" (click)="setFilter('available')">
                  В наличии
                </button>
                <button class="filter-btn" [class.active]="filter === 'discount'" (click)="setFilter('discount')">
                  Со скидкой
                </button>
              </div>
            </div>
          </div>

          <!-- Список товаров -->
          <div class="products-list" *ngIf="filteredProducts.length; else emptyCart">
            <app-product 
              *ngFor="let product of filteredProducts; trackBy: trackByProductId"
              [product]="product"
              [selected]="isSelected(product.id)"
              (selectionChange)="onProductSelected($event)"
              (quantityChange)="onQuantityChange($event)"
              (remove)="onProductRemove($event)"
              (quickView)="onQuickView($event)"
              (addRelated)="onAddRelated($event)">
            </app-product>

            <!-- Блок с рекомендациями -->
            <!-- <div class="recommendations" *ngIf="recommendedProducts.length">
              <div class="recommendations-header">
                <h3>Вам также может понравиться</h3>
                <button class="refresh-btn" (click)="refreshRecommendations()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                  </svg>
                </button>
              </div>
              <div class="recommendations-grid">
                <div class="recommendation-card" *ngFor="let item of recommendedProducts">
                  <div class="rec-image">
                    <img [src]="item.image || 'assets/images/product-placeholder.svg'" [alt]="item.name">
                  </div>
                  <div class="rec-info">
                    <h4>{{ item.name }}</h4>
                    <div class="rec-price">{{ item.price | number:'1.0-2':'ru' }} ₽</div>
                  </div>
                  <button class="rec-add" (click)="addRecommendedToCart(item)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div> -->
          </div>

          <!-- Пустая корзина -->
          <ng-template #emptyCart>
            <div class="empty-cart">
              <div class="empty-illustration">
                <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="60" cy="60" r="52" fill="#F3F4F6" stroke="#E5E7EB" stroke-width="2"/>
                  <path d="M40 40L80 80M80 40L40 80" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round"/>
                  <circle cx="60" cy="60" r="12" fill="#3C8A27" fill-opacity="0.2"/>
                </svg>
              </div>
              <h2>Корзина пуста</h2>
              <p>Добавьте товары из каталога, чтобы продолжить покупки</p>
              <div class="empty-actions">
                <button class="btn primary" (click)="router.navigate(['/catalog'])">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                  </svg>
                  Перейти в каталог
                </button>
                <button class="btn secondary" (click)="openCreatePopup()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                  Создать новую корзину
                </button>
              </div>
            </div>
          </ng-template>
        </div>

        <!-- Правая колонка - итоги и оформление -->
        <div class="cart-sidebar" *ngIf="activeBasket?.products?.length">
          <div class="sidebar-sticky">
            <!-- Блок итогов -->
            <div class="summary-card">
              <h3>Ваш заказ</h3>
              
              <div class="summary-items">
                <div class="summary-row">
                  <span>Товары ({{ totalItems }} шт)</span>
                  <span>{{ subtotal | number:'1.0-2':'ru' }} ₽</span>
                </div>
                
                <div class="summary-row discount" *ngIf="totalDiscount > 0">
                  <span>Скидка</span>
                  <span>-{{ totalDiscount | number:'1.0-2':'ru' }} ₽</span>
                </div>
                
                <div class="summary-row" *ngIf="deliveryCost">
                  <span>Доставка</span>
                  <span>{{ deliveryCost | number:'1.0-2':'ru' }} ₽</span>
                </div>
              </div>

              <div class="summary-total">
                <span>Итого</span>
                <span class="total-amount">{{ total | number:'1.0-2':'ru' }} ₽</span>
              </div>

              <div class="promo-code" *ngIf="showPromo">
                <input type="text" 
                       placeholder="Промокод" 
                       [(ngModel)]="promoCode"
                       (keyup.enter)="applyPromo()"
                       class="promo-input">
                <button class="promo-btn" (click)="applyPromo()" [disabled]="!promoCode.trim()">
                  Применить
                </button>
              </div>

              <button class="checkout-btn" 
                      (click)="proceedToCheckout()"
                      [disabled]="!canProceedToCheckout()">
                <span>Перейти к оформлению</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
              </button>

              <div class="secure-checkout">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                <span>Безопасная оплата</span>
              </div>
            </div>

            <!-- Блок с дополнительной информацией -->
            <div class="info-card">
              <div class="info-item" (click)="toggleDeliveryInfo()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
                <span>Информация о доставке</span>
                <svg class="arrow" [class.rotated]="deliveryInfoOpen" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                </svg>
              </div>
              <div class="info-content" *ngIf="deliveryInfoOpen">
                <p>Бесплатная доставка от 3000 ₽</p>
                <p>Срок доставки: 2-4 дня</p>
                <p>Самовывоз: сегодня</p>
              </div>
            </div>

            <!-- Блок с поддержкой -->
            <div class="support-card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
              </svg>
              <div>
                <h4>Нужна помощь?</h4>
                <p>Свяжитесь с нами в чате</p>
              </div>
              <button class="chat-btn" (click)="openChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Quick View Modal -->
  <div class="modal-overlay" *ngIf="quickViewProduct" (click)="closeQuickView()"></div>
  
  <div class="modal" *ngIf="quickViewProduct">
    <div class="modal-header">
      <h2>Быстрый просмотр</h2>
      <button class="close-btn" (click)="closeQuickView()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <!-- Здесь контент быстрого просмотра -->
      <p>Информация о товаре: {{ quickViewProduct.fullName }}</p>
    </div>
  </div>
</div>