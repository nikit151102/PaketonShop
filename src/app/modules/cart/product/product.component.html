<div class="product-card" [class.selected]="selected" [class.has-discount]="hasDiscount">
  <!-- Шапка с чекбоксом и статусом -->
  <div class="product-header">
    <label class="selection-toggle">
      <input type="checkbox" [checked]="selected" (change)="onSelectionChange($event)" class="selection-input" />
      <div class="custom-checkbox">
        <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        </svg>
      </div>
      <span class="selection-label">Выбрать</span>
    </label>

    <!-- Бейдж скидки -->
    <div class="discount-badge" *ngIf="hasDiscount">
      <svg class="discount-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z" />
      </svg>
      -{{ product.product.discountPercentage }}%
    </div>

    <!-- Статус наличия -->
    <div class="availability-badge" [class.in-stock]="product.product.available">
      <svg class="availability-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
        <path *ngIf="product.product.available" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        <path *ngIf="!product.product.available"
          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
      </svg>
      {{ product.product.available ? 'В наличии' : 'Под заказ' }}
    </div>
  </div>

  <!-- Основное содержимое -->
  <div class="product-main">
    <!-- Изображение товара -->
    <div class="product-image-container">
      <div class="image-wrapper">
        <img [src]="product.product.productImageLink || 'assets/images/product-placeholder.svg'"
          [alt]="product.product.fullName" class="product-image"
          (error)="product.product.productImageLink = 'assets/images/product-placeholder.svg'" />
        <!-- Затемнение при выборе -->
        <div class="image-overlay" *ngIf="selected">
          <svg class="selected-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
        </div>
      </div>

      <!-- Быстрые действия на изображении -->
      <div class="image-actions">
        <button class="quick-action-btn" (click)="toggleWishlist()" [class.active]="isWishlisted" title="В избранное">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path *ngIf="!isWishlisted"
              d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
            <path *ngIf="isWishlisted"
              d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Информация о товаре -->
    <div class="product-info">
      <!-- Артикул и категория -->
      <div class="product-meta">
        <span class="sku">Артикул: {{ product.product.article }}</span>
        <span class="category" *ngIf="product.product.measurementUnitId">шт</span>
      </div>

      <!-- Название товара -->
      <h3 class="product-title" [title]="product.product.fullName">
        {{ product.product.fullName }}
      </h3>

      <!-- Краткое описание -->
      <p class="product-desc" *ngIf="product.product.shortName">
        {{ product.product.shortName }}
      </p>

      <!-- Рейтинг и отзывы -->
      <div class="product-rating" *ngIf="product.product.rating">
        <div class="stars">
          <span *ngFor="let star of [1,2,3,4,5]; let i = index" class="star" [class.filled]="i < getRatingFloor()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
            </svg>
          </span>
        </div>
        <span class="reviews" *ngIf="product.product.reviews">
          {{ product.product.reviews }} отзывов
        </span>
      </div>
    </div>

    <!-- Управление количеством -->
    <div class="quantity-section">
      <div class="quantity-control">
        <button class="qty-btn decrease" (click)="decreaseQty()" [disabled]="product.count <= 1">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13H5v-2h14v2z" />
          </svg>
        </button>

        <div class="qty-display">
          <input type="number" [value]="product.count" (change)="onQuantityInput($event)" min="1" class="qty-input" />
          <span class="qty-unit">шт</span>
        </div>

        <button class="qty-btn increase" (click)="increaseQty()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
        </button>
      </div>

      <div class="price-breakdown">
        <span class="price-per-unit">Цена за шт</span>
        <span class="qty-total">{{ product.count }} × {{ discountPrice | number:'1.0-2':'ru' }} ₽</span>
      </div>
    </div>

    <!-- Цена и итог -->
    <div class="price-section">
      <!-- Цена за единицу -->
      <div class="unit-price">
        <div class="price-main" *ngIf="hasDiscount">
          <span class="price-old">
            {{ product.product.retailPrice | number:'1.0-2':'ru' }} ₽
          </span>
          <span class="price-current">
            {{ discountPrice | number:'1.0-2':'ru' }} ₽
          </span>
        </div>
        <div class="price-main" *ngIf="!hasDiscount">
          <span class="price-current">
            {{ discountPrice | number:'1.0-2':'ru' }} ₽
          </span>
        </div>
        <span class="price-label">за шт</span>
      </div>

      <!-- Общая стоимость -->
      <div class="total-price">
        <span class="total-label">Стоимость</span>
        <span class="total-amount">
          {{ totalPrice | number:'1.0-2':'ru' }} ₽
        </span>
      </div>
    </div>

    <!-- Действия -->
    <div class="actions-section">
      <button class="action-btn remove-btn" (click)="removeProduct()" title="Удалить">
        <svg class="action-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Сопутствующие товары (аккордеон) -->
  <div class="related-products-section" *ngIf="product.product.related?.length">
    <div class="related-header" (click)="toggleRelated()">
      <div class="related-title">
        <svg class="related-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
        </svg>
        <span>С этим товаром покупают</span>
      </div>
      <svg class="toggle-arrow" [class.collapsed]="relatedCollapsed" width="16" height="16" viewBox="0 0 24 24"
        fill="currentColor">
        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
      </svg>
    </div>

    <div class="related-content" [class.collapsed]="relatedCollapsed">
      <div class="related-grid">
        <div class="related-product" *ngFor="let item of product.product.related">
          <div class="related-image">
            <img [src]="item.image || 'assets/images/product-placeholder.svg'" [alt]="item.name" />
          </div>
          <div class="related-info">
            <h5 class="related-name">{{ item.name }}</h5>
            <div class="related-price">
              <span class="related-price-current">{{ item.retailPrice | number:'1.0-2':'ru' }} ₽</span>
              <span class="related-price-old" *ngIf="item.discountPercentage">
                {{ item.wholesalePrice | number:'1.0-2':'ru' }} ₽
              </span>
            </div>
          </div>
          <button class="related-add-btn" title="Добавить в корзину">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>